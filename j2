
pipeline {
  agent {
    label "Java"
  }
  
  stages {
    stage('Build') {
      steps {
        sh 'mvn clean install'
      }
    }
    
    stage('jacoco') {
      steps {
        jacoco()
      }
    }
    
    stage('SonarQube analysis') {
      steps {
        script {
          def scannerHome = tool 'scanner_sonar'
          withSonarQubeEnv('jenkins-sonar') {
            sh """
              ${scannerHome}/bin/sonar-scanner \
              -Dsonar.projectKey=javawebapp \
              -Dsonar.projectName=javawebapp \
              -Dsonar.projectVersion=1.0 \
              -Dsonar.java.binaries='target/classes'
            """
          }
        }
      }
    }
    
    stage("Sonar Quality Gate Check") {
      steps {
        timeout(time: 1, unit: 'HOURS') {
          script {
            def qualityGate = waitForQualityGate()
            if (qualityGate.status != 'OK') {
              error "Pipeline aborted due to quality gate failure: ${qualityGate.status}"
            }
          }
        }
      }
    }
    
    stage('Upload to Nexus') {
      steps {
        nexusArtifactUploader(
          artifacts: [[
            artifactId: 'SimpleWebApplication', 
            classifier: '', 
            file: 'target/SimpleWebApplication.war', 
            type: 'war'
          ]], 
          credentialsId: 'nexus-ssh', 
          groupId: 'com.maven', 
          nexusUrl: '13.201.120.172:8081/', 
          nexusVersion: 'nexus3', 
          protocol: 'http', 
          repository: 'maven-snapshots', 
          version: '1.0.0-SNAPSHOT'
        )
      }
    }
  
stage('Deploy to Tomcat') {
    agent {
        label "Tomcat"
    }
    steps {
        sh 'sudo systemctl stop tomcat'
        
        // Use a script block to run Groovy code and shell commands
        script {
            def NEXUS_URL = "http://13.201.120.172:8081/repository/maven-snapshots/com/maven/SimpleWebApplication/1.0.0-SNAPSHOT/"
            
            // Debug: Print the content fetched from the URL
            def curlOutput = sh(script: "curl -s \"$NEXUS_URL\"", returnStdout: true).trim()
            echo "Curl Output:\n${curlOutput}"
            
            // Extract the latest build name
            def LATEST_BUILD = sh(script: """
                echo "${curlOutput}" | grep 'SimpleWebApplication-1.0.0-.*\\.war' | head -1
            """, returnStdout: true).trim()
            
            echo "LATEST_BUILD is: ${LATEST_BUILD}"

            if (LATEST_BUILD) {
                // Download the latest build from Nexus
                sh """
                    wget --user=admin --password=admin "${NEXUS_URL}${LATEST_BUILD}" -O /home/tomcat/apache-tomcat-10.1.30/webapps/SimpleWebApplication.war
                """
            } else {
                error "No build found to download."
            }
        }
        
        // Start Tomcat
        sh 'sudo systemctl start tomcat'
    }
}


  }
}
